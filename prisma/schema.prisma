

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
  engineType = "client"
  runtime = "bun"
}

datasource db {
  provider = "postgresql" 
}

//User
model User {
  id            String   @id @default(uuid())
  fullName      String
  mobile        String?  @unique
  email         String?  @unique
  role          UserRole

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  authAccounts  AuthAccount[]

  patient       Patient?
  guardian      Guardian?
  doctor        Doctor?
}

//AuthAccount
model AuthAccount {
  id             String   @id @default(uuid())
  provider       AuthProvider
  providerUserId String
  userId         String

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt      DateTime @default(now())

  @@unique([provider, providerUserId])
}

//Users-[Patient,Guardian,Doctor]
model Patient {
  id              String   @id @default(uuid())
  userId          String   @unique

  age             Int
  gender          String
  emergencyPhone  String?
  bookings        Booking[]

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())
}


model Guardian {
  id              String   @id @default(uuid())
  userId          String   @unique

  age             Int
  gender          String
  locality        String
  preferredHospitals Hospital[] @relation("GuardianPreferredHospitals")
  reviews         Review[]

  verificationStatus VerificationStatus @default(PENDING)
  bookings           Booking[]

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())
}

model Doctor {
  id            String   @id @default(uuid())
  userId        String   @unique
  qualification String
  experience    Int
  hospitalName  String
  city          String
  hospitalId    String

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  hospital      Hospital @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  createdAt     DateTime @default(now())
}

//Hospital

model Hospital {
  id          String   @id @default(uuid())
  name        String
  description String?
  phone       String?
  email       String?

  address     String
  city        String
  state       String
  country     String   @default("India")
  pincode     String?

  latitude    Float
  longitude   Float

  isActive    Boolean  @default(true)

  doctors     Doctor[]
  services    HospitalService[]
  bookings           Booking[]
  preferredByGuardians Guardian[] @relation("GuardianPreferredHospitals")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([city])
  @@index([latitude, longitude])
}

//Hospital-Service

model HospitalService {
  hospitalId String
  serviceId  String

  hospital   Hospital @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  service    Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@id([hospitalId, serviceId])
}



//Service

model Service {
  id        String           @id @default(uuid())
  name      String
  description String?
  createdAt DateTime         @default(now())
  hospitals HospitalService[]
  bookings  BookingService[]   // <-- back relation added
}



//Booking
model Booking {
  id           String        @id @default(uuid())
  patientId    String
  guardianId   String?       // Null until a guardian accepts
  hospitalId   String
  
  // Pickup details
  pickupType   PickupType
  pickupLat    Float?        // Required if pickupType is HOME
  pickupLng    Float?        // Required if pickupType is HOME
  pickupAddress String?      // Optional address description
  
  // Scheduling
  scheduledAt  DateTime      // When the pickup should happen
  notes        String?       // Any additional notes from patient
  
  status       BookingStatus @default(REQUESTED)

  patient      Patient   @relation(fields: [patientId], references: [id])
  guardian     Guardian? @relation(fields: [guardianId], references: [id])
  hospital     Hospital  @relation(fields: [hospitalId], references: [id])

  services     BookingService[]
  review       Review?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}


//Booking-Service
model BookingService {
  bookingId String
  serviceId String

  booking  Booking @relation(fields: [bookingId], references: [id])
  service  Service @relation(fields: [serviceId], references: [id])

  @@id([bookingId, serviceId])
}

model Review {
  id          String   @id @default(uuid())
  rating      Int
  comment     String?
  bookingId  String   @unique
  guardianId String

  booking     Booking   @relation(fields: [bookingId], references: [id])
  guardian   Guardian @relation(fields: [guardianId], references: [id])
}


//Enums
enum BookingStatus {
  REQUESTED     // Patient created booking, waiting for guardian
  ACCEPTED      // Guardian accepted the request
  REJECTED      // Guardian rejected (will try next guardian)
  IN_PROGRESS   // Session is ongoing
  COMPLETED     // Session finished successfully
  CANCELLED     // Cancelled by patient or system
}

enum PickupType {
  HOSPITAL      // Patient will meet at hospital
  HOME          // Guardian picks up from patient's location
}

enum AuthProvider {
  MOBILE
  GOOGLE
}

enum UserRole {
  PATIENT
  GUARDIAN
  DOCTOR
}

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
}



